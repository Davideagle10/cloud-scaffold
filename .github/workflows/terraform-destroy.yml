name: Terraform Destroy

on:
  workflow_dispatch:

jobs:
  terraform:
    name: 'Terraform Destroy'
    environment: PROD
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_TERRAFORM_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TERRAFORM_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform

    - name: Get S3 Bucket Name from Terraform State
      id: get-bucket
      run: |
        # Obtener el nombre del bucket del estado de Terraform
        BUCKET_NAME=$(terraform output -raw bucket_name 2>/dev/null || echo "")
        if [ -z "$BUCKET_NAME" ]; then
          # Si no hay output, intentar obtenerlo del state
          BUCKET_NAME=$(terraform state list 2>/dev/null | grep aws_s3_bucket | head -1 | cut -d'"' -f2 || echo "")
        fi
        echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        echo "Bucket detectado: $BUCKET_NAME"
      working-directory: ./terraform

    - name: Empty S3 Bucket Before Destroy
      if: steps.get-bucket.outputs.bucket_name != ''
      run: |
        BUCKET_NAME="${{ steps.get-bucket.outputs.bucket_name }}"
        
        echo "Verificando bucket: $BUCKET_NAME"
        
        # Verificar si el bucket existe
        if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
          echo "âœ… Bucket encontrado: $BUCKET_NAME"
          echo "ðŸ—‘ï¸ Vaciando el bucket..."
          
          # Verificar si el bucket tiene versionado habilitado
          VERSIONING=$(aws s3api get-bucket-versioning --bucket "$BUCKET_NAME" --query 'Status' --output text 2>/dev/null || echo "None")
          echo "Estado de versionado: $VERSIONING"
          
          if [ "$VERSIONING" = "Enabled" ]; then
            echo "Eliminando versiones de objetos..."
            
            # Eliminar todas las versiones de objetos
            aws s3api list-object-versions --bucket "$BUCKET_NAME" --output json | \
            jq -r '.Versions[]? | "--key \"" + .Key + "\" --version-id " + .VersionId' | \
            while read -r line; do
              if [ -n "$line" ]; then
                aws s3api delete-object --bucket "$BUCKET_NAME" $line || true
              fi
            done
            
            # Eliminar delete markers
            aws s3api list-object-versions --bucket "$BUCKET_NAME" --output json | \
            jq -r '.DeleteMarkers[]? | "--key \"" + .Key + "\" --version-id " + .VersionId' | \
            while read -r line; do
              if [ -n "$line" ]; then
                aws s3api delete-object --bucket "$BUCKET_NAME" $line || true
              fi
            done
          fi
          
          # Eliminar objetos actuales (funciona con o sin versionado)
          echo "Eliminando objetos actuales..."
          aws s3 rm s3://"$BUCKET_NAME" --recursive || true
          
          # Verificar que el bucket estÃ¡ vacÃ­o
          OBJECT_COUNT=$(aws s3api list-objects-v2 --bucket "$BUCKET_NAME" --query 'KeyCount' --output text 2>/dev/null || echo "0")
          echo "Objetos restantes: $OBJECT_COUNT"
          
          if [ "$OBJECT_COUNT" = "0" ]; then
            echo "Bucket vaciado completamente"
          else
            echo " AÃºn quedan $OBJECT_COUNT objetos en el bucket"
          fi
          
        else
          echo "El bucket $BUCKET_NAME no existe, continuando..."
        fi
      working-directory: ./terraform

    - name: Terraform Destroy
      run: terraform destroy -auto-approve
      working-directory: ./terraform
      env:
        TF_VAR_aws_access_key_dynamo_user: ${{ secrets.TF_VAR_AWS_ACCESS_KEY_DYNAMO_USER }}
        TF_VAR_aws_region: ${{ secrets.TF_VAR_AWS_REGION }}
        TF_VAR_aws_secret_access_key_dynamo_user: ${{ secrets.TF_VAR_AWS_SECRET_ACCESS_KEY_DYNAMO_USER }}
        TF_VAR_jwt_secret: ${{ secrets.TF_VAR_JWT_SECRET }}
        TF_VAR_account_id: ${{ secrets.TF_VAR_ACCOUNT_ID }}

    - name: Force Cleanup if Destroy Fails
      if: failure()
      run: |
        echo "ðŸ”¨ Ejecutando limpieza forzada..."
        BUCKET_NAME="${{ steps.get-bucket.outputs.bucket_name }}"
        
        # Intentar eliminar el bucket si aÃºn existe
        if [ -n "$BUCKET_NAME" ] && aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
          echo "Forzando eliminaciÃ³n del bucket: $BUCKET_NAME"
          aws s3 rb s3://"$BUCKET_NAME" --force || true
        fi
        
        # Listar recursos huÃ©rfanos
        echo "ðŸ“‹ Recursos que podrÃ­an requerir limpieza manual:"
        aws dynamodb list-tables --query "TableNames[?contains(@, 'Cloud-Scaffold')]" --output table || true
        aws lambda list-functions --query "Functions[?contains(FunctionName, 'Cloud-Scaffold')].FunctionName" --output table || true
      working-directory: ./terraform