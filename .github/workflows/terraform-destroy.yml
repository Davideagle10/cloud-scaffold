name: Terraform Destroy 

on:
  workflow_dispatch:

jobs:
  terraform-destroy:
    name: 'Terraform Destroy - Complete Cleanup'
    environment: PROD
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_TERRAFORM_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TERRAFORM_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Cleanup Orphaned Resources FIRST
      run: |
        echo "üßπ CLEANING ORPHANED RESOURCES FIRST..."
        
        # 1. CloudFront (primero porque depende de otros)
        aws cloudfront list-distributions --query "DistributionList.Items[?contains(Comment, 'Cloud-Scaffold')].Id" --output text | \
        while read dist_id; do
          echo "üóëÔ∏è Deleting CloudFront: $dist_id"
          aws cloudfront delete-distribution --id "$dist_id" || true
        done

        # 2. API Gateway 
        aws apigateway get-rest-apis --query "items[?contains(name, 'Cloud-Scaffold')].id" --output text | \
        while read api_id; do
          echo "üóëÔ∏è Deleting API Gateway: $api_id"
          aws apigateway delete-rest-api --rest-api-id "$api_id" || true
        done

        # 3. Lambda Functions
        aws lambda list-functions --query "Functions[?contains(FunctionName, 'Cloud-Scaffold')].FunctionName" --output text | \
        while read function; do
          echo "üóëÔ∏è Deleting Lambda: $function"
          aws lambda delete-function --function-name "$function" || true
        done

        # 4. DynamoDB Tables
        aws dynamodb list-tables --query "TableNames[?contains(@, 'Cloud-Scaffold')]" --output text | \
        while read table; do
          echo "üóëÔ∏è Deleting DynamoDB table: $table"
          aws dynamodb delete-table --table-name "$table" || true
        done

        # 5. CloudWatch Log Groups (despu√©s de Lambda/API Gateway)
        aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/Cloud-Scaffold" --query "logGroups[].logGroupName" --output text | \
        while read log_group; do
          echo "üóëÔ∏è Deleting Lambda log group: $log_group"
          aws logs delete-log-group --log-group-name "$log_group" || true
        done

        aws logs describe-log-groups --log-group-name-prefix "/aws/apigateway/Cloud-Scaffold" --query "logGroups[].logGroupName" --output text | \
        while read log_group; do
          echo "üóëÔ∏è Deleting API Gateway log group: $log_group"
          aws logs delete-log-group --log-group-name "$log_group" || true
        done

        # 6. IAM Roles (√∫ltimo)
        aws iam list-roles --query "Roles[?contains(RoleName, 'Cloud-Scaffold')].RoleName" --output text | \
        while read role; do
          echo "üóëÔ∏è Deleting IAM role: $role"
          aws iam list-role-policies --role-name "$role" --query "PolicyNames[]" --output text | \
          while read policy; do
            aws iam delete-role-policy --role-name "$role" --policy-name "$policy" || true
          done
          aws iam delete-role --role-name "$role" || true
        done

        echo "‚úÖ Orphaned resources cleanup completed"
      working-directory: ./terraform

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1

    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Destroy
      run: |
        terraform destroy -auto-approve \
          -var="aws_access_key_dynamo_user=${{ secrets.TF_VAR_AWS_ACCESS_KEY_DYNAMO_USER }}" \
          -var="aws_secret_access_key_dynamo_user=${{ secrets.TF_VAR_AWS_SECRET_ACCESS_KEY_DYNAMO_USER }}" \
          -var="jwt_secret=${{ secrets.TF_VAR_JWT_SECRET }}" \
          -var="account_id=${{ secrets.TF_VAR_ACCOUNT_ID }}" \
          -var="aws_region=${{ secrets.TF_VAR_AWS_REGION }}"
      working-directory: ./terraform